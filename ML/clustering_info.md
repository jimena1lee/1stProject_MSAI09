## 전체 진행 과정 정리

### STEP 1: 데이터 로드

60개 학교의 시설물+사고 통합 CSV를 불러옵니다. 컬럼은 총 15개로, 시설물명, 위도, 경도, 시설물 9개 피처, 사고 3개 피처입니다.

이 중 클러스터링에 실제로 사용하는 피처는 12개입니다. 시설물명은 식별용이고, 위도·경도는 성남시 내 좁은 범위라 클러스터링에 기여하지 못하므로 제외합니다(이전에 포함/제외 결과가 동일했던 것으로 확인됨).

---

### STEP 2: 파생 피처 생성

원본 12개 피처에서 클러스터 해석을 돕기 위한 추가 피처를 만듭니다. 이 피처들은 클러스터링 입력에는 넣지 않고, 결과 해석용으로만 사용합니다.

**시설물 총계** = 시설물 9개 피처의 합. 해당 스쿨존의 전체 안전시설 규모를 나타냅니다.

**위험도 비율** = 발생건수 ÷ (시설물 총계 + 1). 시설 대비 사고 비율로, 이 값이 높으면 시설이 있는데도 사고가 많다는 의미입니다. +1은 0으로 나누기 방지용입니다.

**중상 비율** = 사망및중상자수 ÷ (사상자수 + 1). 사고의 심각도를 나타냅니다.

---

### STEP 3: Log 변환 + Z-score 정규화

클러스터링 전에 데이터를 전처리하는 단계입니다. 두 가지를 순서대로 적용합니다.

**① Log 변환 — `log(1+x)`**

카운트 데이터는 대부분 작은 값에 몰려 있고 몇 개만 극단적으로 큽니다. 예를 들어 발생건수는 평균 13.9인데 성수초등학교가 123건입니다. 이런 극단값이 있으면 K-Means가 그쪽으로 끌려가서 나머지 데이터의 차이를 무시하게 됩니다.

`log(1+x)`를 적용하면 큰 값은 압축되고 작은 값 간의 차이는 상대적으로 부각됩니다. 예시로 보면:
- 원본: 1, 5, 10, 123 → 차이가 극단적
- Log 후: 0.69, 1.79, 2.40, 4.82 → 차이가 완만해짐

이 변환 하나로 실루엣이 0.19 → 0.28 수준으로 개선되었습니다.

**② Z-score 정규화 (StandardScaler)**

피처마다 스케일이 다릅니다. 생활안전CCTV는 2~67 범위이고, 옐로카펫은 0~4 범위입니다. 그대로 쓰면 CCTV가 거리 계산을 지배해서 옐로카펫은 사실상 무시됩니다.

Z-score는 각 피처를 평균=0, 표준편차=1로 변환해서 모든 피처가 동등하게 기여하도록 만듭니다. Azure ML Studio의 "Normalize Data (ZScore)" 모듈과 동일한 처리입니다.

---

### STEP 4: PCA 차원 축소 (12차원 → 3차원)

정규화된 12개 피처를 3개의 새로운 축(PC1, PC2, PC3)으로 압축합니다.

**왜 필요한가:** 12개 피처 중 서로 상관이 높은 것들이 많습니다(도로안전표지↔횡단보도 상관계수 0.887). 이런 중복 정보가 많으면 K-Means가 잡음에 휘둘려서 클러스터 경계가 흐려집니다. PCA는 이 중복을 제거하고 핵심 정보만 추출합니다.

**왜 3성분인가:** 여러 성분 수를 비교한 결과 PCA(3)이 최고 성능이었습니다.
- PCA 없음(12차원): 실루엣 0.1897
- PCA(3): **실루엣 0.2843** ← 최고
- PCA(4): 실루엣 0.2440
- PCA(5): 실루엣 0.2358

3성분이 전체 분산의 71%를 설명하면서 잡음을 가장 효과적으로 제거한 겁니다.

**3개 PC의 의미:**
- **PC1 (29.9%)** — "스쿨존 전체 규모". 시설물 12개 피처가 전부 양수로, 시설과 사고가 전반적으로 많은지 적은지를 나타냅니다.
- **PC2 (24.9%)** — "사고 심각도". 사고 3개 피처가 +0.49~0.51로 압도적이고 시설물은 약한 음수. 시설과 무관하게 사고가 얼마나 집중되는지를 나타냅니다.
- **PC3 (16.3%)** — "시설 유형 차이". 도로안전표지·횡단보도·신호등(+) vs 보호구역표지판·적색표면·옐로카펫(-). 교통관리형인지 물리적보호형인지를 나타냅니다.

---

### STEP 5: 최적 K 탐색

PCA로 축소된 3차원 데이터에 K-Means를 k=2~7로 돌려보고, 각각의 실루엣 스코어를 비교합니다.

| k | 실루엣 스코어 |
|---|------------|
| 2 | 0.2677 |
| **3** | **0.2843 ★ 최고** |
| 4 | 0.2644 |
| 5 | 0.2196 |
| 6 | 0.1905 |
| 7 | 0.1952 |

k=3이 최고이고, 해석 측면에서도 "안전 / 보통 / 위험" 3단계가 직관적이므로 k=3을 선택합니다.

---

### STEP 6: K-Means 클러스터링 (k=3)

3차원 PCA 공간에서 K-Means가 60개 스쿨존을 3개 그룹으로 나눕니다. K-Means는 각 클러스터의 중심점(centroid)을 잡고, 모든 데이터를 가장 가까운 중심점에 배정하는 과정을 반복합니다.

결과: 실루엣 스코어 0.2843, Cluster 0에 31개, Cluster 1에 11개, Cluster 2에 18개가 배정되었습니다.

---

### STEP 7: 클러스터 해석

각 클러스터의 평균 피처 값을 비교하여 의미를 부여합니다.

**Cluster 0 (31개교) — "안전"**
시설물 총계 평균 109개로 가장 많고, 사고 8.7건으로 적습니다. 위험도 비율 0.08. 시설이 충분하고 실제로 안전한 스쿨존입니다.

**Cluster 1 (11개교) — "위험 (사고다발)"**
시설물 총계 83개로 중간이지만, 사고가 41.3건으로 압도적으로 많습니다. 위험도 비율 0.54. 시설이 있는데도 사고가 많아서 추가 원인 분석과 대책이 필요한 곳입니다.

**Cluster 2 (18개교) — "보통 (시설부족)"**
시설물 총계 54개로 가장 적고, 사고 6.1건으로 적습니다. 위험도 비율 0.12. 현재는 안전하지만 시설이 부족하므로 예방 차원의 시설 보강이 필요합니다.

---

### STEP 8~9: 시각화

4개의 차트를 생성합니다.

**PCA 산점도** — PC1(x축)과 PC2(y축) 공간에 60개 스쿨존을 클러스터별 색상으로 표시. 클러스터가 시각적으로 얼마나 분리되는지 확인합니다.

**실루엣 플롯** — 각 스쿨존의 실루엣 값을 클러스터별로 정렬. 음수 영역이 적을수록 해당 클러스터의 품질이 좋다는 의미입니다.

**시설물 vs 사고 산점도** — X축에 시설물 총계, Y축에 사고 건수를 놓고 클러스터별 색상으로 표시. Cluster 1이 위쪽(사고 많음)에 몰려 있는 것을 직관적으로 볼 수 있습니다.

**클러스터별 비교 막대차트** — 시설물 총계, 사고건수, 사상자수, 사망중상, 위험도를 정규화해서 클러스터 간 차이를 비교합니다.

---

### STEP 10: 결과 저장

클러스터 라벨(0/1/2)과 한글 라벨(안전/보통/위험)이 포함된 CSV를 저장합니다. 이 파일을 Azure ML Studio에 재업로드하거나, Streamlit/Gradio 앱에서 시각화하는 데 활용할 수 있습니다.

---

### 전체 파이프라인 요약

```
원본 데이터 (60개 × 12피처)
    ↓
Log 변환 — 극단적 이상치 영향 완화
    ↓
Z-score 정규화 — 피처 간 스케일 통일
    ↓
PCA (12차원 → 3차원) — 잡음 제거, 핵심 축 추출
    ↓
K-Means (k=3) — 3개 그룹으로 분류
    ↓
클러스터 해석 — 안전 / 위험 / 시설부족 라벨링
```

각 단계가 실루엣 스코어에 기여한 정도를 보면:
- 시설물만, 정규화만: **0.1810** (Azure ML 기존 결과)
- 사고 데이터 추가: **0.1897** (+0.01)
- Log 변환 추가: **0.2241** (+0.03)
- PCA(3) 추가: **0.2843** (+0.06)